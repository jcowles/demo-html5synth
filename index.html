<!DOCTYPE html>
<html>
  <!-- 
    Prototype Web Audio synth using modern browsers (Chrome/Firefox/Edge/Safari)
  -->
  <head>
    <title>Audio Data API Synth</title>
    <!-- jQuery is just for UI, it's not used for synth/audio support -->
    <link type="text/css" href="css/ui-lightness/jquery-ui-1.8.11.custom.css" rel="stylesheet" />    
    <script type="text/javascript" src="js/jquery-1.5.1.min.js"></script>
    <script type="text/javascript" src="js/jquery-ui-1.8.11.custom.min.js"></script>
    <script>
    $(function() {
        //
        // Initialize jQuery UI elements (sliders)
        //
        oscSliderParams = {
            value: 0,
            min: -48,
            max: 48,
            step: 1
        }

        function uiHandler(elem) {
            return function( event, ui ) { 
                $( "#" + elem ).val( ui.value ); 
            }
        }

        $( "#slider1" ).slider($.extend(oscSliderParams, { slide: uiHandler("freq1") }));
        $( "#slider2" ).slider($.extend(oscSliderParams, { slide: uiHandler("freq2") }));
        $( "#slider3" ).slider($.extend(oscSliderParams, { slide: uiHandler("freq3") }));
        $( "#freq1" ).val( $( "#slider1" ).slider( "value" ) );
        $( "#freq2" ).val( $( "#slider2" ).slider( "value" ) );
        $( "#freq3" ).val( $( "#slider3" ).slider( "value" ) );

        adsrParams = { value: .05, min: 0.0, max: 1.0, step: 0.01 }
        $( "#sliderAttack" ).slider($.extend(adsrParams, { slide: uiHandler("attack") }));
        $( "#attack" ).val( $( "#sliderAttack" ).slider( "value" ) );

        adsrParams = { value: .25, min: 0.0, max: 1.0, step: 0.01 }
        $( "#sliderDecay" ).slider($.extend(adsrParams, { slide: uiHandler("decay") }));
        $( "#decay" ).val( $( "#sliderDecay" ).slider( "value" ) );

        adsrParams = { value: .5, min: 0.0, max: 1.0, step: 0.01 }
        $( "#sliderSustain" ).slider($.extend(adsrParams, { slide: uiHandler("sustain") }));
        $( "#sustain" ).val( $( "#sliderSustain" ).slider( "value" ) );

        adsrParams = { value: .5, min: 0.0, max: 1.0, step: 0.01 }
        $( "#sliderRelease" ).slider($.extend(adsrParams, { slide: uiHandler("release") }));
        $( "#release" ).val( $( "#sliderRelease" ).slider( "value" ) );
    });
    </script>
    <style>
        body { font-family: helvetica, verdana, sans; font-size: 0.9em; margin: 0; min-height: 100vh;}
        .ojText { border:0; color:#f6931f; font-weight:bold; }
        .cta-btn {
          background-color: #f6931f;
          border: none;
          color: #fff;
          padding: 10px 16px;
          border-radius: 4px;
          font-size: 0.95em;
          cursor: pointer;
          box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }
        .cta-btn:hover { background-color: #e68410; }
        .cta-btn:active { transform: translateY(1px); }
        .start-screen {
          display: flex;
          align-items: center;
          justify-content: center;
          min-height: 100vh;
          background: #fff;
        }
        .synth-ui { display: none; padding: 0 16px 24px 16px; }
        body.show-ui .synth-ui { display: block; }
        body.show-ui .start-screen { display: none; }
    </style>
  </head>
  <body id="body">
    <div class="start-screen" id="startScreen">
      <button id="enableAudio" class="cta-btn">Start the synth</button>
    </div>

    <div class="synth-ui" id="synthUi">
      <div style="margin-top: 20px;float: right; font-size: 0.7em; color: #999;">Created by <a href="http://visualcore.com">Jeremy Cowles</a></div>
      <h1 style="font-size: 1.8em">HTML5 Synthesizer</h1>
      <div style="display: none;">
          <input id="doLfo" type="checkbox" value="0">
          <input id="lfo" type="text" size="1" value="0" class="ojText"><label for="doLfo">super-cheesy lfo</label>
          <br/><br/>
      </div>

      The following is a simple synthesizer built with the Web Audio API. It generates wave
      data using oscillators and a volume envelope (see source for details). jQuery is used strictly for
      UI elements and does not play a part in the generation of audio.
      <br/>
      <h3>Keyboard:</h3>
      Black keys: 2 4 5 7 9 -<br/>
      White keys: q w e r t y u i o p<br style="clear: both"/>
      
      <div style="margin-right: 100px; float: left">
          <h3>Oscillators:</h3>
          <input id="osc1" type="checkbox" checked><label for="osc1">Osc-1</label>
          <input type="text" size="1" id="freq1" value="0" class="ojText"><label for="freq1">Semitones (sine)</label>
          <div style="float: left; width: 200px;" id="slider1"></div>

          <br/><br/>
          <input id="osc2" type="checkbox"><label for="osc2">Osc-2</label>
          <input type="text" size="1" id="freq2" value="0" class="ojText"><label for="freq2">Semitones (square)</label>
          <div style="float: left; width: 200px;" id="slider2"></div>

          <br/><br/>
          <input id="osc3" type="checkbox"><label for="osc3">Osc-3</label>
          <input type="text" size="1" id="freq3" value="0" class="ojText"><label for="freq3">Semitones (square)</label>
          <div style="float: left; width: 200px;" id="slider3"></div>
          <br/><br/>
          <br/><br/>
      </div>
      <div style="float: none">
          <h3>Volume Envelope:</h3>
          <input type="text" size="3" id="attack" value="0" class="ojText">
          <label for="attack">Attack</label>
          <div style="float: left; width: 200px; margin-right: 20px;" id="sliderAttack"></div>
          <br/> <br/>
          <input type="text" size="3" id="decay" value="0" class="ojText">
          <label for="decay">Decay</label>
          <div style="float: left; width: 200px; margin-right: 20px;" id="sliderDecay"></div>
          <br/>
          <br/>
          <input type="text" size="3" id="sustain" value="0" class="ojText">
          <label for="sustain">Sustain</label>
          <div style="float: left; width: 200px; margin-right: 20px;" id="sliderSustain"></div>
          <br/>
          <br/>
          <input type="text" size="3" id="release" value="0" class="ojText">
          <label for="release">Release</label>
          <div style="float: left; width: 200px; margin-right: 20px;" id="sliderRelease"></div>
      </div>

      <br/>
      <br/>
      <strong>What?! It doesn't work?</strong>
      <ul>
          <li>Click "Start the synth" or press a key to unlock sound (modern browsers block autoplay).</li>
          <li>Does the page have focus? Try clicking the page and then using the hot keys.</li>
          <li>Use a current browser with Web Audio support (Chrome, Firefox, Edge, Safari).</li>
          <li>Still quiet? Reload the page to reset the audio context.</li>
      </ul>
      <br/>
      <br/>
      <br/>
    </div>
    
    <script type="text/javascript">
      const noteFrequencies = {
        "Q": 440.0,
        "2": 466.16,
        "W": 493.88,
        "E": 523.25,
        "4": 554.37,
        "R": 587.33,
        "5": 622.25,
        "T": 659.26,
        "Y": 698.46,
        "7": 739.99,
        "U": 783.99,
        "I": 880.0,
        "9": 932.33,
        "O": 987.77,
        "P": 1046.5,
        "-": 1108.73,
        "[": 1174.66,
        "=": 1244.51,
        "]": 1381.51,
        "\\": 1396.91
      };

      const activeNotes = new Map();
      let audioCtx;

      function normalizeKey(key) {
        if (!key) return null;
        const aliases = { "+": "=", "_": "-", "{": "[", "}": "]", "|": "\\" };
        if (aliases[key]) return aliases[key];
        if (key.length === 1 && key.match(/[a-z]/i)) {
          return key.toUpperCase();
        }
        return key.length === 1 ? key : null;
      }

      function getAudioContext() {
        if (!audioCtx) {
          const AudioContextCtor = window.AudioContext || window.webkitAudioContext;
          audioCtx = new AudioContextCtor();
        }
        if (audioCtx.state === "suspended") {
          audioCtx.resume();
        }
        return audioCtx;
      }

      function semitoneRatio(semitones) {
        return Math.pow(2, semitones / 12);
      }

      function createOscillator(ctx, type, baseFreq, semitoneOffset) {
        const osc = ctx.createOscillator();
        osc.type = type;
        osc.frequency.value = baseFreq * semitoneRatio(semitoneOffset);
        return osc;
      }

      function readEnvelope() {
        return {
          attack: parseFloat($("#attack").val()) || 0,
          decay: parseFloat($("#decay").val()) || 0,
          sustain: parseFloat($("#sustain").val()) || 0,
          release: parseFloat($("#release").val()) || 0
        };
      }

      function startNoteForKey(rawKey) {
        const key = normalizeKey(rawKey);
        if (!key || activeNotes.has(key)) return;

        const baseFreq = noteFrequencies[key];
        if (!baseFreq) return;

        const ctx = getAudioContext();
        const now = ctx.currentTime;
        const envelope = readEnvelope();
        const baseGain = 0.2;

        const gainNode = ctx.createGain();
        gainNode.gain.setValueAtTime(0, now);
        gainNode.connect(ctx.destination);
        gainNode.gain.linearRampToValueAtTime(baseGain, now + envelope.attack);
        gainNode.gain.linearRampToValueAtTime(baseGain * envelope.sustain, now + envelope.attack + envelope.decay);

        const baseNoteFreq = baseFreq / 4;
        const oscDefinitions = [
          { id: "osc1", type: "sine", semitoneInput: "#freq1" },
          { id: "osc2", type: "square", semitoneInput: "#freq2" },
          { id: "osc3", type: "square", semitoneInput: "#freq3" }
        ];

        const oscillators = [];
        oscDefinitions.forEach(def => {
          const checkbox = document.getElementById(def.id);
          if (!checkbox || !checkbox.checked) return;
          const offset = parseFloat($(def.semitoneInput).val()) || 0;
          const osc = createOscillator(ctx, def.type, baseNoteFreq, offset);
          osc.connect(gainNode);
          osc.start(now);
          oscillators.push(osc);
        });

        if (!oscillators.length) {
          gainNode.disconnect();
          return;
        }

        activeNotes.set(key, { gainNode, oscillators });
      }

      function stopNoteForKey(rawKey) {
        const key = normalizeKey(rawKey);
        const noteState = activeNotes.get(key);
        if (!noteState) return;

        const ctx = getAudioContext();
        const now = ctx.currentTime;
        const release = parseFloat($("#release").val()) || 0;

        noteState.gainNode.gain.cancelScheduledValues(now);
        const currentGain = noteState.gainNode.gain.value;
        noteState.gainNode.gain.setValueAtTime(currentGain, now);
        noteState.gainNode.gain.linearRampToValueAtTime(0, now + release);

        noteState.oscillators.forEach(osc => {
          osc.stop(now + release + 0.05);
        });

        setTimeout(() => {
          noteState.gainNode.disconnect();
        }, (release + 0.1) * 1000);

        activeNotes.delete(key);
      }

      function handleKeyDown(event) {
        if (event.repeat) return;
        startNoteForKey(event.key);
      }

      function handleKeyUp(event) {
        stopNoteForKey(event.key);
      }

      function enableAudio() {
        const ctx = getAudioContext();
        if (ctx.state === "suspended") {
          ctx.resume();
        }
        document.body.classList.add("show-ui");
      }

      document.addEventListener("keydown", handleKeyDown);
      document.addEventListener("keyup", handleKeyUp);
      document.addEventListener("DOMContentLoaded", () => {
        const enableButton = document.getElementById("enableAudio");
        if (enableButton) {
          enableButton.addEventListener("click", enableAudio);
        }
      });
    </script>

  </body>
</html>

